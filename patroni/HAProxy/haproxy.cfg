global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

defaults
    log global
    mode tcp
    option tcplog
    timeout connect 5s
    timeout client 1h
    timeout server 1h
    timeout check 5s
    retries 3
	
	
# =============== ОСНОВНЫЕ ПОТОКИ ===============

# Запись — только мастер (через PgBouncer)
listen postgres_write
    bind *:5000
    option httpchk GET /primary
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server node1 192.168.31.171:6432 maxconn 100 check port 8008
    server node2 192.168.31.172:6432 maxconn 100 check port 8008
    server node3 192.168.31.173:6432 maxconn 100 check port 8008

# Чтение — только реплики (исключаем мастера)
listen postgres_read
    bind *:5001
    balance roundrobin
    option httpchk GET /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server node1 192.168.31.171:6432 maxconn 100 check port 8008
    server node2 192.168.31.172:6432 maxconn 100 check port 8008
    server node3 192.168.31.173:6432 maxconn 100 check port 8008


# =============== СТАТИСТИКА ===============
# Веб-интерфейс мониторинга HAProxy
listen stats
        mode http
        bind *:7000
        stats enable
        stats uri /

